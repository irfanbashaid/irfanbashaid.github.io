<html>
    <head>
        <title>Ethereum voting</title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js" ></script>
    </head>
    <body>
        <h2>Blockchain based voting platform</h2>
        <div class="candParentDiv">
            <div class="TrumpDiv">
                <h5>Trump</h5>
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg"/>
                <p>votes: <span id="TrumpVotes">0</span></p>
                <button class="voteBtn" onclick="voting('Trump')">vote</button>
            </div>
            <div class="BidenDiv">
                <h5>Biden</h5>
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg"/>
                <p>votes: <span id="BidenVotes">0</span></p>
                <button class="voteBtn" onclick="voting('Biden')">vote</button>
            </div>
        </div>
        <div>
            <button class="resultBtn" onclick="result()">Result</button>
        </div>
        <style>
            img {
                width: 130px;
                height: 150px;
            }
            body{
                text-align: center;
            }
            .candParentDiv {
                display: flex;
            }
            .TrumpDiv {
                margin-left: auto;
                margin-right: 20px;
            }
            .BidenDiv {
                margin-left: 20px;
                margin-right: auto;
            }
            .voteBtn{
                background: deepskyblue;
                padding: 5px 10px 5px 10px;
            }
            .resultBtn {
                background: red;
                padding: 10px 20px 10px 20px;
                margin-top: 40px;
            }
        </style>
        <script>
            let abiJson = [
                {
                    "inputs": [],
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "candReg",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "getTime",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "result",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "voteMap",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "voting",
                    "outputs": [],
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ]
            let contractAddress = "0x58f5e19e216161d52a53de6ba79ae1da45385bfc";    
            let walletAddress = "";
            let web3Instance;
            let VotingContract;
            init = async() => {
                if(window.ethereum) {
                    try {
                        let enableRes = await window.ethereum.enable();
                        walletAddress = enableRes[0];
                        web3Instance = new window.Web3(window.ethereum);
                        VotingContract = new web3Instance.eth.Contract(abiJson, contractAddress);
                        _updateVotes();
                    }
                    catch(e) {
                        console.log(e);
                        return alert("Account not connected");
                    }
                }
                else {
                    return alert("Please install metamask!");
                }
            }
            init();
            voting = (candName) => {
                VotingContract.methods.voting(candName).send({from: walletAddress})
                .on('receipt', function(receipt){
                    if(receipt && receipt.status) {
                        _updateVotes();
                        return alert("successfully voted!");
                    }
                    else {
                        return alert("transaction failed!")
                    }
                })
            }
            result=() =>{
                VotingContract.methods.result().call()
                .then(function(result){
                    alert(result);
                });
            }
            _updateVotes=() => {
                updateVotes("Trump");
                updateVotes("Biden");
            }
            updateVotes=(candName) =>{
                VotingContract.methods.voteMap(candName).call()
                .then(function(voteCount){
                    document.getElementById(candName+'Votes').innerHTML = voteCount;
                });
            }
        </script>
    
    </body>
</html>

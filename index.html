<html>
    <head>
        <title>voting</title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js"></script>
    </head>
    <body>
        <h2>Ethereum voting</h2>
        <div id="parentDiv">
            <div id="trumpDiv">
                <h3>Trump</h3>
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg"/>
                <h5>Votes:<span id="TrumpVoteId">0</span></h5>
                <button class="voteButton" onclick="voting('Trump')">Vote</button>
            </div>
            <div id="bidenDiv">
                <h3>Biden</h3>
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg"/>
                <h5>Votes:<span id="BidenVoteId">0</span></h5>
                <button class="voteButton" onclick="voting('Biden')">Vote</button>
            </div>
        </div>
        <button class="resultBtn" onclick="result()">Result</button>
        <script>
            let web3Ins = new window.Web3(window.ethereum);
            let pubAddr = "";
            let contractIns;
            let abiJson = [
                {
                    "constant": false,
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "voting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getCurrentTime",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "result",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "voteCountMap",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                }
            ];
            let contractAddress = "0xf061c1eafa3a070ba0bb2fd3eed31c64c3924896";
            init = async() =>{
                let walletAddr = await window.ethereum.enable();
                pubAddr = walletAddr[0];
                contractIns = new web3Ins.eth.Contract(abiJson,contractAddress)
                getVotes()
            }
            init();
            function getVotes() {
                _getVotes("Biden");
                _getVotes("Trump");
            }
            function _getVotes(candName) {
                // console.log(candName)
                contractIns.methods.voteCountMap(candName).call().then(function(result){
                    // console.log(result)
                    let spanId = candName+"VoteId"
                    document.getElementById(spanId).innerText = result;
                })
            }

            function voting(candName) {
                contractIns.methods.voting(candName).send({from:pubAddr}).then(function(result){
                    if(result.status) {
                        alert("successfully voted");
                        getVotes();
                        return;
                    }
                    else {
                        return alert("transaction failed");
                    }
                })
            }
            function result() {
                contractIns.methods.result().call().then(function(result){
                    return alert(result);
                })
            }
        </script>
    </body>
    <style>
        body {
            text-align: center;
        }
        img {
            width: 200px;
            border-radius: 14px;
        }
        #parentDiv {
            display: flex;
        }
        #bidenDiv, #trumpDiv {
            margin: auto;
        }
        .voteButton {
            background: blue;
            color: white;
            padding: 10px 20px;
            border-radius: 7px;
        }
        .resultBtn {
            margin-top: 45px;
            padding: 20px 40px;
            background: aqua;
            border-radius: 7px;
        }
    </style>
</html>

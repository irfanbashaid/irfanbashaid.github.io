<html>
    <head>
        <title>Election</title>
        <script src="https://cdn.jsdelivr.net/npm/web3@4.2.2/dist/web3.min.js" type="text/javascript"></script>
    </head>
    <body>
        <h2>Ethereum voting</h2>
        <div class="votersSection">
            <div class="trumpCard">
                <p>Trump</p>
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg"/>
                <p>No of votes: <span id="trumpVotes">0</span></p>
                <button onclick="vote('TRUMP')" class="voteBtn">Vote</button>
            </div>
            <div class="bidenCard">
                <p>Biden</p>
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg"/>
                <p>No of votes: <span id="bidenVotes">0</span></p>
                <button onclick="vote('BIDEN')" class="voteBtn">Vote</button>
            </div>
        </div>
        <button onclick="result()" class="resultBtn">Result</button>
        <style>
            body {
                text-align: center;
            }

            .votersSection {
                display: flex;
            }

            .trumpCard {
                margin-left: auto;
                margin-right: 20px;
            }

            .bidenCard {
                margin-right: auto;
                margin-left: 20px;
            }

            img {
                width: 200px;
                border-radius: 7px;
            }

            .voteBtn {
                background: pink;
                padding: 10px 20px;
                border-radius: 7px;
            }

            .resultBtn {
                background: red;
                padding: 10px 20px;
                border-radius: 7px;
                margin-top: 40px;
            }

        </style>
        <script>
            let walletAddress;
            let web3Instance;
            let contInstance;
            let abiJson = [
                {
                    "constant": false,
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "candidate_name",
                            "type": "string"
                        }
                    ],
                    "name": "voting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getCurrentTime",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "no_of_votes",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "result",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                }
            ]
            let contractAddress = "0xb0cf03646bb16b85afd3fb73387d5f6360c6ffc8";
            async function init() {
                let walletCon = await window.ethereum.enable();
                walletAddress = walletCon[0]; 
                web3Instance = new window.Web3(window.ethereum);
                console.log(web3Instance);
                contInstance = new web3Instance.eth.Contract(abiJson,contractAddress);
                console.log(contInstance)
                get_no_of_votes();
            }
            init();
            function vote(candName){
                contInstance._methods.voting(candName).send({from: walletAddress})
                .on('receipt', function(receipt){
                    console.log(receipt);
                    if(receipt.status) {
                        get_no_of_votes();
                        return alert("Successfully voted");
                    }
                    else {
                        return alert("Transaction failed");
                    }
                })
            }

            function get_no_of_votes() {
                contInstance._methods.no_of_votes("TRUMP").call()
                .then(function(trumpVotes){
                    document.getElementById("trumpVotes").innerText = trumpVotes; 
                });
                contInstance._methods.no_of_votes("BIDEN").call()
                .then(function(bidenVotes){
                    document.getElementById("bidenVotes").innerText = bidenVotes; 
                });
            }

            function result() {
                contInstance._methods.result().call()
                .then(function(status){
                    return alert(status)
                });
            }
        </script>
    </body>
</html>

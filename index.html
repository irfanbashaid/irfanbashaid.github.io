<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
        <title>Ethereum voting</title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.min.js" type="text/javascript"></script>
    </head>
    <body>
        <h1>Blockchain based Voting platform</h1>
        <div>
            <div class="walletDet">
                <p>Wallet Address: <span id="walletAddress"></span></p>
                <p>wallet balance: <span id="walletBalance">0</span> ETH</p>
            </div>
        </div>
        <div class="parentCandDiv">
            <div class="candDiv">
                <h3>Candidate Name: Trump</h3>
                <img class="candImg" src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/Donald_Trump_official_portrait.jpg/800px-Donald_Trump_official_portrait.jpg"/>
                <p class="voteTxt">Votes:<span id="TrumpVotes">0</span></p>
                <button onclick="voting('Trump')" class="voteBtn">Vote</button>
            </div>
            <div class="candDiv">
                <h3>Candidate Name: Biden</h3>
                <img class="candImg" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/68/Joe_Biden_presidential_portrait.jpg/800px-Joe_Biden_presidential_portrait.jpg"/>
                <p class="voteTxt">Votes:<span id="BidenVotes">0</span></p>
                <button onclick="voting('Biden')" class="voteBtn">Vote</button>
            </div>
        </div>
        <button class="ResultBtn" onclick="show_result()">Result</button>
        <script>
            let contract_address = "0xaf1c0ee3994417b466c796111472836f9863f07f";
            let abiJson = [
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getBlockchainTime",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "no_of_votes",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "result",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "voting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ]
                let walletAddress = "";
                let web3Instance;
                let contractInstance;
                async function init() {
                    let walletCon = await window.ethereum.enable();
                    walletAddress = walletCon[0];
                    document.getElementById("walletAddress").innerText = walletAddress;
                    web3Instance = new window.Web3(window.ethereum);
                    contractInstance = new web3Instance.eth.Contract(abiJson,contract_address); 
                    set_no_of_votes();
                    setWalletBalance(walletAddress);
                }
                init();
                function setWalletBalance(walletAddress) {
                    web3Instance.eth.getBalance(walletAddress,function(error, balance){
                        document.getElementById("walletBalance").innerText = web3Instance.utils.fromWei(balance, 'ether');
                    })
                }
                function voting(candName) {
                    contractInstance.methods.voting(candName).send({from:walletAddress})
                    .on('receipt', function(receipt){
                        if(receipt && receipt.status && receipt.status == true) {
                            set_no_of_votes();
                            return alert("successfully voted for "+candName);
                        }
                        else {
                            return alert("Transaction failed");
                        }
                    });
                }
                function show_result() {
                    contractInstance.methods.result().call(function(error,status){
                        return alert(status);
                    })
                }
                function set_no_of_votes() {
                    setBidenVotes();
                    setTrumpVotes();
                }
                function setBidenVotes() {
                    contractInstance.methods.no_of_votes("Biden").call(function(error,voteCount){
                        document.getElementById("BidenVotes").innerText = voteCount;
                    })
                }
                function setTrumpVotes() {
                    contractInstance.methods.no_of_votes("Trump").call(function(error,voteCount){
                        document.getElementById("TrumpVotes").innerText = voteCount;
                    })
                }
        </script>
        <style>
            body{
                text-align: center;
            }
            div.parentCandDiv {
                display: flex;
            }
            .candDiv {
                margin: auto;
            }
            .candImg {
                width: 300px;
                height: 377px;
                border-radius: 14px;
            }
            .voteBtn {
                width: 180px;
                height: 60px;
                font-size: 20px;
                color: red;
                background: aqua;
                border-radius: 14px;
            }
            .ResultBtn {
                margin-top: 55px;
                width: 180px;
                height: 60px;
                font-size: 20px;
                color:  white;
                background: red;
                border-radius: 14px;
            }
            .voteTxt {
                font-size: 25px;
            }
            .walletDet{
                border: 1px solid grey;
                width: 615px;
                margin-left: auto;
            }
        </style>
    </body>
</html>

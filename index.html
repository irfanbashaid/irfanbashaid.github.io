<html>
    <head>
        <title>Voting D-APP</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/4.16.0/web3.min.js"></script>
    </head>
    <body>
        <h1>Ethereum based voting platform</h1>
        <div id="accountDetails">
            <h3>Account Details</h3>
            <p>Wallet Address: <span id="walletAddress"></span></p>
            <p>Ether Balance: <span id="etherBalance">-</span> ETH</p>
            <p>Voted: <span id="isVoted"></span> </p>
        </div>
        <div id="parentDiv">
            <div id="trumpDiv">
                <p>TRUMP</p>
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/16/Official_Presidential_Portrait_of_President_Donald_J._Trump_%282025%29.jpg"/>
                <p>No.of Votes Received: <span id="TRUMPVoteCount"></span></p>
                <button id="trumpVoteBtn" onclick="vote('TRUMP')">VOTE</button>
            </div>
            <div id="bidenDiv">
                <p>BIDEN</p>
                <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg"/>
                <p>No.of Votes Received: <span id="BIDENVoteCount"></span></p>
                <button id="bidenVoteBtn" onclick="vote('BIDEN')">VOTE</button>
            </div>
        </div>
        <br/>
        <br/>
        <br/>
        <br/>
        <h3>Click below to know the Election Status</h3>
        <button id="resultStateBtn" onclick="getResult()">status</button>
        <script>
            let walletAddress = '';
            let web3Ins;
            let contractIns;
            let jsonInterface = [
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "isRegistered",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "address",
                            "name": "",
                            "type": "address"
                        }
                    ],
                    "name": "isVoted",
                    "outputs": [
                        {
                            "internalType": "bool",
                            "name": "",
                            "type": "bool"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "result_state",
                    "outputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "name": "voteCount",
                    "outputs": [
                        {
                            "internalType": "uint256",
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "internalType": "string",
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "voting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                }
            ];
            let votingContractAddress = "0xac218b0be07359f728512491fede840cfed4fc82";
            async function connectWallet() {
                let connRes = await window.ethereum.enable();
                walletAddress = connRes[0];
                document.getElementById("walletAddress").innerText = walletAddress;
            }

            function setBalance(){
                web3Ins.eth.getBalance(walletAddress).then(result => {
                    let balanceInEther = web3Ins.utils.fromWei(result, 'ether');
                    document.getElementById("etherBalance").innerText = balanceInEther;
                });
            }

            function isVotedCheck() {
                contractIns._methods.isVoted(walletAddress).call().then((result)=>{
                    if(result === true ) {
                        document.getElementById("isVoted").innerText = "Yes";
                    } else {
                        document.getElementById("isVoted").innerText = "No";
                    }
                });
            }

            function getResult() {
                contractIns._methods.result_state().call().then((result)=>{
                    return alert(result);
                });
            }

            function noOfVotes(candName) {
                contractIns._methods.voteCount(candName).call().then((result)=>{
                    document.getElementById(candName+"VoteCount").innerText = result;
                });
            }

            function vote(candName) {
                contractIns._methods.voting(candName).send({from:walletAddress})
                .on('receipt', function(receipt){
                    setVoteCount();
                    return alert("Transaction completed!");
                });
            }

            function setVoteCount() {
                noOfVotes("TRUMP");
                noOfVotes("BIDEN");
            }

            function setContracIns() {
                contractIns = new web3Ins.eth.Contract(jsonInterface, votingContractAddress);
                isVotedCheck();
                setVoteCount();
            }
            function setWeb3Ins() {
                web3Ins = new window.Web3(window.ethereum);
                setBalance();
                setContracIns();
            }
            async function init() {
                await connectWallet();
                setWeb3Ins();
            }
            init();
        </script>
        <style>
            body {
                text-align: center;
            }
            #parentDiv {
                display: flex;
            }
            #trumpDiv {
                margin-left: auto;
                padding-right: 20px;
            }
            #bidenDiv {
                margin-right: auto;
                padding-left: 20px;
            }
            img {
                width: 300px;
                height: 400px;
                border-radius: 7px;
            }

            #trumpVoteBtn {
                background-color: aqua;
                padding: 10px 20px;
                border-radius: 7px;
            }

            #bidenVoteBtn {
                background-color: aqua;
                padding: 10px 20px;
                border-radius: 7px;
            }

            #resultStateBtn {
                background-color: deeppink;
                padding: 10px 20px;
                border-radius: 7px;
                color: white;
            }
        </style>
    </body>
</html>

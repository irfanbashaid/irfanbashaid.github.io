<html>
    <head>
        <title>Ethereum voting</title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.34/dist/web3.js"></script>
    </head>
    <body>
        <div>
            <h1>Ethereum based voting</h1>
        </div>
        <div id="candDetailsParent">
            <div id="candDetails">
                <div>
                    <div>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Donald_Trump_official_portrait.jpg"/>
                    </div>
                    <div>
                        Kiran
                    </div>
                    <div>
                        <span id="kiranVotes">0</span>&nbsp;Votes
                    </div>
                    <div>
                        <button onclick="vote('Kiran')">Vote</button>
                    </div>
                </div>
                <div>
                    <div>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/6/68/Joe_Biden_presidential_portrait.jpg"/>
                    </div>
                    <div>
                        Kumar
                    </div>
                    <div>
                        <span id="kumarVotes">0</span>&nbsp;Votes
                    </div>
                    <div>
                        <button onclick="vote('Kumar')">Vote</button>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <button id="result" onclick="result()">Result</button>
        </div>
        <style>

            body {
                text-align: center;
            }

            img {
                width: 160px;
            }

            #candDetailsParent {
                text-align: center;
            }

            #candDetails {
                display: flex;
                justify-content: center;
            }
            #candDetails div{
                margin: 10px;
            }

            button {
                width: 100px;
                height: 33.33px;
                background: blue;
                color: white;
            }

            #result {
                background-color: brown;
                margin-top: 50px;
            }
        </style>
        <script>
            let abi = [
                {
                    "constant": true,
                    "inputs": [
                        {
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "getCurrentVotes",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [],
                    "name": "startVoting",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "result",
                    "outputs": [
                        {
                            "name": "",
                            "type": "string"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": true,
                    "inputs": [],
                    "name": "getBlockchainTime",
                    "outputs": [
                        {
                            "name": "",
                            "type": "uint256"
                        }
                    ],
                    "payable": false,
                    "stateMutability": "view",
                    "type": "function"
                },
                {
                    "constant": false,
                    "inputs": [
                        {
                            "name": "candName",
                            "type": "string"
                        }
                    ],
                    "name": "vote",
                    "outputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "function"
                },
                {
                    "inputs": [],
                    "payable": false,
                    "stateMutability": "nonpayable",
                    "type": "constructor"
                }
            ]
            let contractAddress = "0x3cfc715c6b7c9ef221a5cc6c2ea910c3b5d4e9ad";
            // console.log(window.ethereum);
            // console.log();
            let walletAddress = "";
            let web3Ins = "";
            let contIns = "";
            init();
            async function init() {
                let enableRes = await window.ethereum.enable();
                if(enableRes) {
                    walletAddress = enableRes[0];
                    web3Ins = new window.Web3(window.ethereum);
                    contIns = new web3Ins.eth.Contract(abi, contractAddress);
                    console.log(contIns)
                    checkVotes();
                }
            }

            function checkVotes() {
                checkKiranVotes();
                checkKumarVotes();
            }

            function result() {
                contIns.methods.result().call(function(error, result){
                    if(result){
                        return alert(result);
                    }
                })
            }

            function checkKiranVotes() {
                contIns.methods.getCurrentVotes("Kiran").call(function(error, result){
                    if(result){
                        document.getElementById("kiranVotes").innerHTML = result;
                    }
                    checkKiranVotes();
                });
            }

            function checkKumarVotes() {
                contIns.methods.getCurrentVotes("Kumar").call(function(error, result){
                    if(result){
                        document.getElementById("kumarVotes").innerHTML = result;
                    }
                    checkKumarVotes();
                });
            }

            function vote(candidateName) {
                contIns.methods.vote(candidateName).send({from: walletAddress})
                .on('transactionHash', function(hash){
                })
                .on('receipt', function(receipt){
                    console.log(receipt);
                    if(receipt && receipt.status) {
                        return alert("Successfully voted!")
                    }
                    else {
                        return alert("Voting not successfull!");
                    }
                })
                .on('confirmation', function(confirmationNumber, receipt){
                })
                .on('error', function(error, receipt) {
                });
            }
        </script>
    </body>
</html>

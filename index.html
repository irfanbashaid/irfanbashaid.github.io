<html>
    <head>
        <title>
            Election
        </title>
        <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.12/dist/web3.min.js"></script>
    </head>
    <body>
        <h1 style="text-align: center">Blockchain Voting</h1>

        <button onclick="voting('Rahul')">Vote Rahul</button>
        <button onclick="voting('Kiran')">Vote Kiran</button>

        <h3>Votes received for Rahul:<span id="rahulVoteCount">0</span></h3>
        <h3>Votes received for Kiran:<span id="kiranVoteCount">0</span></h3>

        <button onclick="result()">winner</button>
        <script>
            let web3;
            let contractAddress = "0x056e04c42c0b0930aca6c27bbb23f08cc364e2ef";
            let abi = [
	{
		"constant": false,
		"inputs": [],
		"name": "setTime",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "candName",
				"type": "string"
			}
		],
		"name": "voting",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "cand1",
				"type": "string"
			},
			{
				"name": "cand2",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "",
				"type": "string"
			}
		],
		"name": "candReg",
		"type": "event"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "candidateNames",
		"outputs": [
			{
				"name": "",
				"type": "string"
			},
			{
				"name": "",
				"type": "string"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "currentTime",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "eleStartTime",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "candName",
				"type": "string"
			}
		],
		"name": "getNumberOfVotesRecieved",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "result",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]
            
            let contInstance;

            if(window.web3 != undefined){
                //metamask found ethereum browser
                window.ethereum.enable();
                web3 = new Web3(window.web3.currentProvider);
                contInstance = new web3.eth.Contract(abi,contractAddress);
                updateCandVotes();

            }
            else {
                alert("please install metamask");
            }
            function voting(candName){
                window.web3.eth.getAccounts((err,res)=>{
                    let userAddress = res[0];
                    contInstance.methods.voting(candName).send({from:userAddress}).on('transactionHash',function(hash){
                        isSuccess(hash);
                    });
                })
            }

            function updateCandVotes() {

                updateRahulVote();
                updateKiranVote();
            }

            function updateRahulVote() {
                contInstance.methods.getNumberOfVotesRecieved("Rahul").call(function(error,data){
                    document.getElementById("rahulVoteCount").innerText = data;
                    updateRahulVote();
                });
            }

            function updateKiranVote() {
                contInstance.methods.getNumberOfVotesRecieved("Kiran").call(function(error,data){
                    document.getElementById("kiranVoteCount").innerText = data;
                    updateKiranVote();
                });
            }

            function isSuccess(hash) {
                web3.eth.getTransactionReceipt(hash,function(err,res){
                    if(err) {
                        return alert("Error");
                    }
                    else if(res){
                        if(res.status == "0x0"){
                            return alert("txFailed");
                        }
                        else {
                            return alert("success");
                        }
                    }
                    else {
                        //pending
                        isSuccess(hash);
                    }
                })
            }
            function result() {
                contInstance.methods.result().call(function(error,resCase){
                    if(resCase == 4){
                            return alert("voting isn't started");
                    }
                    else if(resCase == 0 ) {
                        return alert("voting isnt ended");
                    }
                    else if(resCase == 1){
                        return alert("if candidate 1 won the election");
                    }
                    else if(resCase == 2){
                        return alert("if candidate 2 won the election");
                    }
                    return alert("Tie:both recieves the same");
                });
            }
        </script>
    </body>
</html>
